# 📊 Визуальная схема системы подсчёта токенов

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ЭКРАН ЧАТА (ChatScreen)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  📱 HuggingFace Chat                      [🧪 Токены] ← Кнопка панели  ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ Выберите модель:  [Очистить чат]                                        ││
│  │  [DeepSeek V3]  [Qwen3 235B]  [DictaLm 3.0]  ← Выбор модели            ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 🧪 Панель тестирования токенов                               [✕]        ││
│  ├─────────────────────────────────────────────────────────────────────────┤│
│  │ 📊 Текущий анализ                                                       ││
│  │ ████████████░░░░░░░░  65% использовано                                  ││
│  │ 📥 Входные: 520/32000  📤 Выходные: 1024  💰 Стоимость: 0.0345¢        ││
│  ├─────────────────────────────────────────────────────────────────────────┤│
│  │ Выберите тестовый запрос:                                               ││
│  │                                                                          ││
│  │ ┌─────────────────────────────────────────────────────────────────┐    ││
│  │ │ Короткий запрос                                             [✓] │    ││
│  │ │ ~20 токенов                                                      │    ││
│  │ └─────────────────────────────────────────────────────────────────┘    ││
│  │ ┌─────────────────────────────────────────────────────────────────┐    ││
│  │ │ Средний запрос                                              [✓] │    ││
│  │ │ ~100 токенов                                                     │    ││
│  │ └─────────────────────────────────────────────────────────────────┘    ││
│  │ ┌─────────────────────────────────────────────────────────────────┐    ││
│  │ │ Длинный запрос                                              [✓] │    ││
│  │ │ ~500 токенов                                                     │    ││
│  │ └─────────────────────────────────────────────────────────────────┘    ││
│  │ ┌─────────────────────────────────────────────────────────────────┐    ││
│  │ │ Очень длинный запрос                                        [✓] │    ││
│  │ │ ~1500 токенов                                                    │    ││
│  │ └─────────────────────────────────────────────────────────────────┘    ││
│  │ ┌─────────────────────────────────────────────────────────────────┐    ││
│  │ │ Экстремально длинный                                        [⚠] │    ││
│  │ │ ~3000+ токенов (может превысить лимит)                           │    ││
│  │ └─────────────────────────────────────────────────────────────────┘    ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ ⏱️ Время: 2340ms  📥 Входные: 127  📤 Выходные: 423  📊 Всего: 550    ││
│  │ 💰 Стоимость: 0.0345¢                        ← Метрики последнего ответа││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 📈 Статистика сессии                                                    ││
│  │ 💬 Сообщений: 5   📥 Входных: 750   📤 Выходных: 2100   💰 0.1234¢    ││
│  │ Всего токенов: 2850  │  Средняя стоимость/запрос: 0.0247¢              ││
│  │                                              ← Накопительная статистика ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                          💬 История чата                                 ││
│  │  ┌───────────────────────────────┐                                      ││
│  │  │ Привет! Расскажи про KMP      │  ← Сообщение пользователя           ││
│  │  └───────────────────────────────┘                                      ││
│  │                    ┌──────────────────────────────────────┐             ││
│  │                    │ Kotlin Multiplatform - это...        │             ││
│  │                    │                          [📋 Копировать]            ││
│  │                    └──────────────────────────────────────┘             ││
│  │                                      ← Ответ модели                      ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ [  Напишите сообщение...                          ] [Отправить]         ││
│  │                                               ← Поле ввода               ││
│  └─────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🔄 Поток данных

```
┌──────────────┐
│ ПОЛЬЗОВАТЕЛЬ │
└──────┬───────┘
       │ Вводит текст
       ▼
┌──────────────────────┐
│  ChatScreen (UI)     │
│  - TextField         │◄──┐
└──────┬───────────────┘   │
       │ UpdateCurrentMessage  │ Обновление UI
       ▼                      │
┌──────────────────────┐     │
│  ChatViewModel       │     │
│  - TokenEstimator    │─────┘
│  - TokenAnalysis     │
└──────┬───────────────┘
       │ Оценка токенов (клиент)
       │ currentTokenAnalysis
       │
       │ SendMessageToChat
       ▼
┌──────────────────────┐
│  HuggingFaceApi      │
│  - Отправка запроса  │
└──────┬───────────────┘
       │ HTTP Request
       ▼
┌──────────────────────┐
│  HuggingFace Server  │
│  - Обработка         │
│  - Подсчёт токенов   │
└──────┬───────────────┘
       │ Response + Usage
       ▼
┌──────────────────────┐
│  ChatViewModel       │
│  - Точные токены     │
│  - Расчёт стоимости  │
│  - Накопление stats  │
└──────┬───────────────┘
       │ State Update
       ▼
┌──────────────────────┐
│  ChatScreen          │
│  - ResponseMetrics   │
│  - SessionStats      │
│  - Messages          │
└──────────────────────┘
```

## 📦 Структура State

```
ChatState
├── chatMessages: List<MessageModel>
│   └── [user msg, assistant msg, user msg, ...]
│
├── currentMessage: String?
│   └── "Текст, который пользователь вводит..."
│
├── selectedModel: AiModel
│   └── DEEPSEEK | QWEN | LLAMA
│
├── ⏱️ Метрики последнего ответа
│   ├── lastResponseTimeMs: Long?
│   ├── lastInputTokens: Int?
│   ├── lastOutputTokens: Int?
│   ├── lastTotalTokens: Int?
│   └── lastEstimatedCost: Double?
│
├── 📊 Статистика сессии
│   ├── totalSessionInputTokens: Int
│   ├── totalSessionOutputTokens: Int
│   └── totalSessionCost: Double
│
├── 🧪 Тестирование
│   ├── showTokenTestPanel: Boolean
│   └── currentTokenAnalysis: TokenAnalysis?
│       ├── estimatedInputTokens: Int
│       ├── estimatedOutputTokens: Int
│       ├── usageLevel: TokenUsageLevel
│       ├── isWithinLimits: Boolean
│       ├── estimatedCost: Double
│       └── warning: String?
│
└── isLoading: Boolean
```

## 🎨 Цветовые индикаторы

```
Использование лимита токенов:

0%    25%    50%    75%    90%    100%
├──────┼──────┼──────┼──────┼──────┤
│ 🟢 LOW      │ 🟡 MEDIUM │ 🟠 HIGH │ 🔴 CRITICAL
│ Зелёный     │ Жёлтый    │ Оранжевый │ Красный
│ Безопасно   │ Умеренно  │ Высоко  │ ОПАСНО!
└─────────────┴───────────┴─────────┴──────────┘

Примеры:
• 20 токенов из 32000   = 0.06%  → 🟢 LOW
• 500 токенов из 32000  = 1.56%  → 🟢 LOW
• 20000 токенов из 32000 = 62.5% → 🟡 MEDIUM
• 28000 токенов из 32000 = 87.5% → 🟠 HIGH
• 31000 токенов из 32000 = 96.9% → 🔴 CRITICAL
```

## 💰 Расчёт стоимости

```
Формула:
cost = (inputTokens × costPerInputToken) + (outputTokens × costPerOutputToken)

Пример для DeepSeek V3:
┌─────────────────────────────────────────┐
│ Входные токены: 500                     │
│ Стоимость входа: $0.00015 / 1K токенов  │
│ Расчёт: 500 × 0.00015 / 1000 = 0.000075 │
├─────────────────────────────────────────┤
│ Выходные токены: 800                    │
│ Стоимость выхода: $0.0006 / 1K токенов  │
│ Расчёт: 800 × 0.0006 / 1000 = 0.00048   │
├─────────────────────────────────────────┤
│ ИТОГО: 0.000075 + 0.00048 = 0.000555$  │
│ ≈ 0.0555¢                                │
└─────────────────────────────────────────┘
```

## 🔄 Жизненный цикл запроса

```
1. Ввод текста
   └→ updateCurrentMessage()
      └→ TokenEstimator.estimateTokens()
         └→ TokenAnalysis.analyze()
            └→ State update (currentTokenAnalysis)
               └→ UI показывает оценку

2. Отправка
   └→ sendMessageToChat()
      ├→ State update (isLoading = true)
      ├→ Измерение времени начато
      └→ HuggingFaceApi.sendMessage()

3. Получение ответа
   └→ result.fold()
      ├→ onSuccess:
      │  ├→ Извлечение usage (точные токены)
      │  ├→ Расчёт стоимости (TokenEstimator)
      │  ├→ Накопление статистики
      │  └→ State update:
      │     ├─ lastInputTokens
      │     ├─ lastOutputTokens
      │     ├─ lastTotalTokens
      │     ├─ lastEstimatedCost
      │     ├─ totalSessionInputTokens +=
      │     ├─ totalSessionOutputTokens +=
      │     └─ totalSessionCost +=
      │
      └→ onFailure:
         └→ ShowError effect

4. Отображение
   └→ ChatScreen recompose
      ├→ ResponseMetrics показывает метрики
      ├→ SessionStatisticsCard показывает статистику
      └→ Messages добавлено в список
```

## 🧪 Тестовые сценарии (визуализация)

```
1. Короткий запрос (~20 токенов)
   ┌────────────────────────────────┐
   │ "Привет! Расскажи факт"        │
   └────────────────────────────────┘
   ████░░░░░░░░░░░░░░░░░░░░░░░░░░░░  0.06% от лимита
   🟢 Безопасно | ⏱️ 500-1500ms | 💰 ~0.0001¢

2. Средний запрос (~100 токенов)
   ┌────────────────────────────────┐
   │ "Я изучаю KMP. У меня есть     │
   │ несколько вопросов..."         │
   └────────────────────────────────┘
   ████░░░░░░░░░░░░░░░░░░░░░░░░░░░░  0.31% от лимита
   🟢 Безопасно | ⏱️ 2-4sec | 💰 ~0.03-0.05¢

3. Длинный запрос (~500 токенов)
   ┌────────────────────────────────┐
   │ "Мне нужна помощь в            │
   │ оптимизации производительности │
   │ Compose Multiplatform...       │
   │ [... много текста ...]         │
   └────────────────────────────────┘
   ████░░░░░░░░░░░░░░░░░░░░░░░░░░░░  1.56% от лимита
   🟢 Безопасно | ⏱️ 5-10sec | 💰 ~0.08-0.15¢

4. Очень длинный (~1500 токенов)
   ┌────────────────────────────────┐
   │ "Я работаю над комплексным     │
   │ корпоративным приложением...   │
   │ [... очень много текста ...]   │
   └────────────────────────────────┘
   ████████░░░░░░░░░░░░░░░░░░░░░░░░  4.69% от лимита
   🟢 Безопасно | ⏱️ 10+ sec | 💰 ~0.20-0.40¢

5. Экстремально длинный (~3000+)
   ┌────────────────────────────────┐
   │ [... огромное количество ...   │
   │ ... повторяющегося текста ...] │
   └────────────────────────────────┘
   ████████████████████████░░░░░░░░  9.38%+ от лимита
   🟡 Умеренно (DeepSeek/Qwen)
   🔴 ОПАСНО! (DictaLm - превышает 8K!)
   ⏱️ Может быть ошибка | 💰 Высокая
```

## 📚 Файловая структура

```
composeApp/src/commonMain/kotlin/ru/macdroid/worknote/
│
├── features/chat/
│   ├── domain/
│   │   ├── models/
│   │   │   ├── AiModel.kt
│   │   │   ├── MessageModel.kt
│   │   │   ├── TokenTestCase.kt       ← НОВЫЙ
│   │   │   └── ModelTokenLimits.kt    ← НОВЫЙ (внутри TokenTestCase)
│   │   │
│   │   ├── utils/
│   │   │   ├── TokenEstimator.kt      ← НОВЫЙ
│   │   │   └── StringFormatExtensions.kt ← НОВЫЙ
│   │   │
│   │   └── ChatContract.kt            ← ОБНОВЛЁН
│   │
│   ├── presentation/
│   │   ├── components/
│   │   │   ├── TokenTestPanel.kt      ← НОВЫЙ
│   │   │   └── SessionStatisticsCard.kt ← НОВЫЙ
│   │   │
│   │   ├── ChatViewModel.kt           ← ОБНОВЛЁН
│   │   └── ChatScreen.kt              ← ОБНОВЛЁН
│   │
│   └── data/
│       └── api/
│           └── HuggingFaceApi.kt
│
└── [... остальные файлы ...]
```

---

*Эта схема помогает понять:*
- *Как выглядит UI*
- *Как течёт поток данных*
- *Какие есть состояния*
- *Как работают тестовые сценарии*
- *Структуру файлов*

